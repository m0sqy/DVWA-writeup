# CSP Bypass

Objective

Bypass Content Security Policy (CSP) and execute JavaScript in the page.

## low

Examine response headers and you'll find it a little bit different from the other
challenges: a new header called 'Content-Security-Policy'.  
This is kind of a passive way to defend against XSS as the server itself
provides rules about which third-party site to trust to the client.  
```
Content-Security-Policy: script-src 'self' https://pastebin.com  example.com code.jquery.com https://ssl.google-analytics.com ;
```

Let's edit something in [pastebin](https://pastebin.com).  
```js
document.write(document.cookie);
```

Use this one if you don't know how to generate a URL:
[https://pastebin.com/raw/WDaZpsXq]().  
Send the URL to DVWA and wait for your cookie to show itself.

**a problem you may encounter:**

There's been a security measure to prevent pastebin contents from getting
utilized by XSS. `pastebin.com` now responses with two additional headers:  
```
Content-Type: text/plain; charset=utf-8
X-Content-Type-Options: nosniff
```

Basically it is telling the browser not to detect type of the content
automatically, so the `<script>` token would only see a plain text and refuse 
to interpret.  
If you really want to see your script get executed, simulate a scenario with no
XSS protection by intercepting the response from `pastebin.com` in burpsuite 
and delete the 'X-Content-Type-Options' header.

## medium

In this level, we have a `unsafe-inline` in CSP, which enables inline scripts.
However, scripts must have their "nonce" attribute the same as the one in CSP
to prove that they're generated by server admin who has access to nonce
generating functions.

So what we're doing now is to make a collision between our handcrafted nonce 
and the one DVWA gives us, letting the browser trust what we upload.  
The nonce DVWA gives us looks like this: 
`TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=`.

Decode it in base64 and we get: "Never going to give you up".  
This is a good meme, yet a bad nonce, so we craft our input like this:  
```html
<script nonce="TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=">document.write(document.cookie);</script>
```

## high

Scenario of untrusted local files.  
Supposing we've managed to get the write access of `source/jsonp.php`, changing
it would cause an immediate code execution.

For example, instead of calling a function from GET parameter, we execute our
own script:  
```php
/*$outp = array ("answer" => "15");
echo $callback . "(".json_encode($outp).")";*/
echo "document.getElementById(\"answer\").innerHTML = document.cookie;";
```

You can see something like this after clicking the button:

> 1+2+3+4+5=PHPSESSID=eu9u9msm3jphhkrqtt9j4mcgc5; security=high
